var global={bStart:false,squence:[],bImage:false,bShowLine:false,bRested:true};$(document).ready(function(){$(".changInputBox").on("click",function(){$("#wrongTips").text("");if($(this).attr("id")=="toTextBoxLink"){global.bImage=false;$("#textPasswd").show();$("#imagePasswd").hide();$("#textPasswdNumber").val("")}else{global.bImage=true;$("#textPasswd").hide();$("#imagePasswd").show();imagePwdZone.resetImage()}});$("#showLine").on("click",function(){global.bShowLine=$(this).prop("checked");if(!global.bRested){imagePwdZone.resetImage()}});$("#cancelButton,#closeButton").on("click",function(){cancelPasswd()});$("#okButton").on("click",function(){var a=$("#textPasswdNumber").val();confirmPasswd(a)});$("#title").bind("mousedown",function(a){if(a.button==0){var b={x:event.clientX,y:event.clientY};$.ajax({url:"http://gbackup/capturePwdWindow",type:"POST",data:JSON.stringify(b),success:function(c){},error:function(c){},complete:function(c){}})}});$("#imagePasswd").hide()});function confirmPasswd(a){var b={};b.bImage=global.bImage;b.squence=a;$.ajax({url:"http://gbackup/confirm",type:"POST",data:JSON.stringify(b),success:function(c){if(c=="ok"){}else{if(c=="error"){$("#wrongTips").text("{{pwd_js_wrongTips_passwordError_lang}}");if(global.bImage&&global.bShowLine){imagePwdZone.drawWrongImage()}}else{if(c=="empty"){$("#wrongTips").text("{{pwd_js_wrongTips_passwordError_lang}}")}}}},error:function(){},complete:function(){}})}function cancelPasswd(){$.ajax({url:"http://gbackup/quitConfirm",type:"GET",success:function(a){},error:function(){},complete:function(){}})}window.onload=function(){imagePwdZone.init()};var observe=function(a,b,c){this.addEventListener(b,c,false)};function circleButton(a,c,b){this.x=a;this.y=c;this.context=b;this.outerR=30;this.innerR=10;this.getX=function(){return this.x};this.getY=function(){return this.y};this.setsStrokeStyle=function(d){this.strokeStyle=d};this.setInnerFillStyle=function(d){this.innerFillStyle=d};this.drawOuter=function(){this.context.beginPath();this.context.strokeStyle=this.strokeStyle;this.context.lineWidth=2;this.context.arc(this.x,this.y,this.outerR,0,2*Math.PI,true);this.context.closePath();this.context.fillStyle="#ffffff";this.context.fill();this.context.stroke()};this.drawInner=function(){this.context.beginPath();this.context.strokeStyle=this.innerFillStyle;this.context.arc(this.x,this.y,this.innerR,0,2*Math.PI,true);this.context.closePath();this.context.fillStyle=this.innerFillStyle;this.context.fill();this.context.stroke()};this.mousedown=function(d){console.log(this.x+" "+this.y+" mouse dwon")};this.mouseup=function(d){console.log(this.x+" "+this.y+" mouse up")};this.mousemove=function(d){console.log(this.x+" "+this.y+" mouse move")};this.isAtMe=function(f){var e={};e.x=this.x;e.y=this.y;var d=publicCall.distance(e,f)<=this.outerR;return d}}var imagePwdZone={init:function(){this.canvas=document.getElementById("imagePwd");this.context=this.canvas.getContext("2d");observe($("#imagePwd"),"mousemove",function(d){imagePwdZone.mousemove(d)});observe($("#imagePwd"),"mousedown",function(d){imagePwdZone.mousedown(d)});observe($("#imagePwd"),"mouseup",function(d){imagePwdZone.mouseup(d)});this.offX=40;this.offY=40;this.delta=110;this.buttons=[];this.strokeStyle="#D8DFE7";this.okInnerFillStyle="#96E9A2";this.errInnerFillStyle="#FDDB8A";this.initInnerFillStyle="#D8DFE7";for(var c=0;c<3;++c){for(var a=0;a<3;++a){var b=new circleButton(a*this.delta+this.offX,c*this.delta+this.offY,this.context);b.setsStrokeStyle(this.strokeStyle);b.setInnerFillStyle(this.initInnerFillStyle);b.drawOuter();b.drawInner();this.buttons.push(b)}}},getPointOnCanvas:function(a,c){var b=this.canvas.getBoundingClientRect();return{x:(a-b.left)*this.canvas.width/b.width,y:(c-b.top)*this.canvas.height/b.height}},mousemove:function(f){if(!global.bStart){return}var g=this.getPointOnCanvas(f.clientX,f.clientY);if(g.x>0&&g.x<300&&g.y>0&&g.y<3*this.delta){var b=parseInt(3*g.x/this.canvas.width);var c=parseInt(3*g.y/this.canvas.height);var a=c*3+b;if(typeof(this.buttons[a])!="undefined"&&this.buttons[a]!=null&&this.buttons[a].isAtMe(g)){if($.inArray(a,global.squence)==-1){global.squence.push(a);if(global.bShowLine){this.buttons[a].setInnerFillStyle(this.okInnerFillStyle);this.buttons[a].drawInner();if(global.squence.length>1){var d={x:this.buttons[a].getX(),y:this.buttons[a].getY()};this.linkLastCircle(d,this.lastCircle,this.okInnerFillStyle)}this.lastCircle=a}}}}},mousedown:function(d){var f=this.getPointOnCanvas(d.clientX,d.clientY);if(f.x>0&&f.x<this.canvas.width&&f.y>0&&f.y<this.canvas.height){if(!global.bRested){this.resetImage()}global.squence=[];global.bStart=true;var b=parseInt(3*f.x/this.canvas.width);var c=parseInt(3*f.y/this.canvas.height);var a=c*3+b;if(this.buttons[a].isAtMe(f)){if($.inArray(a,global.squence)==-1){global.squence.push(a);if(global.bShowLine){this.buttons[a].setInnerFillStyle(this.okInnerFillStyle);this.buttons[a].drawInner();this.lastCircle=a}}}}},mouseup:function(c){if(!global.bStart){return}if(global.squence.length!=0){var a="";for(var b=0;b<global.squence.length;++b){a+=global.squence[b]}confirmPasswd(a);if(global.bShowLine){global.bRested=false}else{global.bRested=true}}global.bStart=false},linkLastCircle:function(c,b,a){this.context.beginPath();this.context.strokeStyle=a;this.context.moveTo(this.buttons[b].getX(),this.buttons[b].getY());this.context.lineTo(c.x,c.y);this.context.stroke();this.context.closePath()},resetImage:function(){if(global.squence.length!=0){var c=global.squence[0];if(global.squence.length>1){var d={};for(var b=1;b<global.squence.length;++b){var a=global.squence[b];d.x=this.buttons[a].getX();d.y=this.buttons[a].getY();this.linkLastCircle(d,c,"#ffffff");c=a}}for(var b=this.buttons.length-1;b>=0;b--){this.buttons[b].setsStrokeStyle(this.strokeStyle);this.buttons[b].setInnerFillStyle(this.initInnerFillStyle);this.buttons[b].drawOuter();this.buttons[b].drawInner()}}global.bRested=true},drawWrongImage:function(){if(global.squence.length!=0){var c=global.squence[0];if(global.squence.length>1){var d={};for(var b=1;b<global.squence.length;++b){var a=global.squence[b];d.x=this.buttons[a].getX();d.y=this.buttons[a].getY();this.linkLastCircle(d,c,this.errInnerFillStyle);this.buttons[c].setInnerFillStyle(this.errInnerFillStyle);this.buttons[c].drawInner();c=a}}this.buttons[c].setInnerFillStyle(this.errInnerFillStyle);this.buttons[c].drawInner()}}};publicCall={distance:function(b,a){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))}};