if(typeof ContextMenu=="undefined"){var ContextMenu={IMPORTANDEXPORTCONTEXT:"importAndExportContextMenu",EXPORTCONTEXT:"ExportContextSubMenu",THREADCONTEXT:"threadContextMenu"}}var global={smsList:0,listSmsChecked:0,objSmsListSize:0,speed:"normal",hide:function(a){if(a==null){return}a.stop(true,true).hide(global.speed)},show:function(a){if(a==null){return}a.stop(true,true).show(global.speed)}};function copyCollMess(a){$.ajax({url:"http://vivozs/mmssms/smsSendder",type:"POST",data:{type:"copy",body:a},success:function(c){var b=$("#bubble");if(c=="success"){b.find(".bubble_text").html('<div class="ok" ></div>'+langs.smsmms_js_copysuccess_str)}else{b.find(".bubble_text").html('<div class="fail" ></div>'+langs.smsmms_js_copyfail_str)}b.show();setTimeout(function(){b.hide()},1000)}})}function sendCollMess(a){$.ajax({url:"http://vivozs/mmssms/smsSendder",type:"POST",data:{type:"forward",body:a},success:function(b){console.log(b)}})}function refreshCollMess(){$(".contextmenu").hide();$("#collectionLoading").show();collSms.window.location.reload()}function getDress(c){var b=c+"Loading";c=c+"Iframe";_obj=$("HTML");var a=_obj[0].innerText;a=a.substr(0,5);if(a=="Error"||a=="Not F"){frames[c].document.write('<div style="font-family: 微软雅黑,Verdana,sans-serif,宋体;text-align:center;line-height:400px;color:#666;">页面加载失败，请尝试点击<a  style ="background-color:#d8ecf3; color:#FFF; padding:0px 10px;" onclick="parent.refreshCollMess()">刷新</a>重试</div>')}document.getElementById(b).style.display="none"}function getMmsCall(b,a){$.ajax({url:"http://vivozs/mmssms/mms/"+b,type:"GET",success:function(c){if(c=="Invalid"){$("#tips").text(langs.smsmms_js_invalid_mms_str);$("#tips").fadeIn(500).fadeOut(2000);return}a(b)}})}var MmsPlayer=function(){var f="";var i=0;var a=0;var b=[];var d=[];var c=0;var h=0;var g;var e={getSubject:function(){return subject},getTotalTime:function(){return time},getCurrentTime:function(){return currentTime},loadMms:function(n,q,r){f=n;i=q;b.splice(0,r.length);b=r.concat();for(var m=0;m<b.length;m++){var k=0;var o=m+1;for(var l=0;l<o;l++){k+=b[l].duration}d.splice(m,0,k)}console.log(d);g=document.getElementById("ShowFrame")},play:function(){$("#StopAndPlay").attr("play",true);var k=(new Date()).getTime();(function j(n){n=n||(new Date()).getTime();var l=n-k;a+=l;if(a>=i){a=0;c=0;h=0;$("#SlideBar").val(0);$("#DynamicTime").text((new Date(0)).toMMSS());$("#StopAndPlay").removeAttr("play");var m=template("MmsFrame",{list:b[c].content});g.innerHTML=m;return}if(a>d[c]){c++;var m=template("MmsFrame",{list:b[c].content});g.innerHTML=m}$("#SlideBar").val(a);$("#DynamicTime").text((new Date(a)).toMMSS());k=n;h=webkitRequestAnimationFrame(j)})()},pause:function(){$("#StopAndPlay").removeAttr("play");webkitCancelRequestAnimationFrame(h);h=0},destroy:function(){this.pause();f="";i=0;a=0;b.splice(0,b.length);d.splice(0,d.length);c=0;h=0},prev:function(){c=Math.max(0,--c);a=d[c]-b[c].duration;var j=template("MmsFrame",{list:b[c].content});g.innerHTML=j;if(h==0){$("#SlideBar").val(a);$("#DynamicTime").text((new Date(a)).toMMSS())}},next:function(){c=Math.min(b.length-1,++c);a=d[c]-b[c].duration;var j=template("MmsFrame",{list:b[c].content});g.innerHTML=j;if(h==0){$("#SlideBar").val(a);$("#DynamicTime").text((new Date(a)).toMMSS())}}};return{getInstance:function(){return e}}}();function mmsClick(a){var b=parseInt(a.parentNode.parentNode.parentNode.id);getMmsCall(b,function(){b=b+"Mms";window.showMms(b,function(d,f,g){var e=new Date(f);var c=template("MmsPreView",{firstframes:g[0].content,max:f,time:e.toMMSS()});art.dialog({title:langs.smsmms_js_subject_str+d,content:c,lock:true,dblclickNotHide:true,width:600,height:450,padding:0,initialize:function(){MmsPlayer.getInstance().loadMms(d,f,g)},beforeunload:function(){MmsPlayer.getInstance().destroy()}})})})}function Pre(a){MmsPlayer.getInstance().prev()}function Aft(a){MmsPlayer.getInstance().next()}function StopPlay(a){if(a.getAttribute("play")){MmsPlayer.getInstance().pause()}else{MmsPlayer.getInstance().play()}}function resizeMMSImage(c){var b=Math.min(200,c.width);var a=Math.floor(b/c.width*c.height);c.style.width=b+"px";c.style.height=a+"px"}function getSimSmsCall(){InitStatus.simSms=false;$("#smsSearch").attr("disabled","disabled");$(".menu-search").addClass("disable");$.ajax({url:"http://vivozs/mmssms/simsms",type:"GET",success:function(a){console.log("getSimSmsCall ==> "+a);$("#smsSearch").removeAttr("disabled");$(".menu-search").removeClass("disable");window.getSimSms(function(c){$("#allSimSms").attr("checked",false);$("#simNum").text(c.length+"");if(c.length==0){$("#simcontent .noSmscontent").show()}else{var b=template("SimSms",{list:c,MessageType:MessageType});$("#simSmscontent").html(b);$("#simcontent .noSmscontent").hide()}InitStatus.simSms=true})},complete:function(){$("#bubble").hide()}})}function getFavSmsCall(){InitStatus.favSms=false;$.ajax({url:"http://vivozs/mmssms/favsms",type:"GET",success:function(a){console.log("getFavSmsCall ==> "+a);window.getFavSms(function(c){InitStatus.favSms=true;$("#allFavSms").attr("checked",false);$("#favNum").text(c.length+"");if(c.length===0){$("#favcontent .noSmscontent").show()}else{var b=template("FavSms",{list:c,MessageType:MessageType});$("#favSmscontent").html(b);$("#favcontent .noSmscontent").hide()}})},complete:function(){$("#bubble").hide()}})}function getMmsSmsCall(b){$(".contextmenu").hide();document.body.appendChild(document.getElementById("bubble"));var a=$("#bubble");a.find(".bubble_text").html('<div class="refresh" ></div>'+langs.share_reflashing_str);a.show();if(b){$("#threads").empty();$("#mmsSmscontent").empty();$("#favSmscontent").empty();$("#simSmscontent").empty();$("#searchresultcontent").empty();$("#searchcontent").hide();InitStatus.favSms=false;InitStatus.simSms=false;$(".category-selected").removeClass("category-selected");$("#apply2all").prop("checked",false);$("#passwd").val("")}$.ajax({url:"http://vivozs/mmssms",type:"POST",data:{reflash:b},success:function(d){console.log("getMmsSmsCall ==> "+d);var c=JSON.parse(d);if(c.response=="ok"){window.getThreads(1,getThreadsCallback);if(c.gemini_support==false){$("#btn_SIM1").text(langs.smsmms_js_btn_send_str);$("#btn_SIM2").hide()}else{$("#btn_SIM1").html('<span class="arial">SIM1</span>'+langs.smsmms_js_btn_send_str);$("#btn_SIM2").show()}if(c.slot0==1){$("#btn_SIM1").removeAttr("disabled")}else{$("#btn_SIM1").attr("disabled","disabled")}if(c.slot1==1){$("#btn_SIM2").removeAttr("disabled").show()}else{$("#btn_SIM2").attr("disabled","disabled")}if(c.vivoCloud==true){$("#backupSms").removeClass("disable")}else{$("#backupSms").addClass("disable")}$("#unConected").hide()}else{$("#unConected").show()}$("#allSms,#allThreads,#allSimSms,#allFavSms").attr("checked",false);$("#delSms").addClass("disable");$("#delThreads,#exportThreads").attr("disabled",true);$("#bubble").hide();if(c.bSupportFav==false){$("#fav").hide();$(".drawer .list").css({height:"440px"})}else{$("#fav").show();$(".drawer .list").css({height:"410px"});getFavSmsCall()}getSimSmsCall()}})}function onConnected(b){if(localStorage.messPrompt=="1"){$("#messPrompt").hide()}CloseArtDialog();if(b.conected==true){$("#unConected").hide();var a=$("#bubble");a.find(".bubble_text").html('<div class="refresh" ></div>'+langs.share_reflashing_str);a.show();window.getThreads(1,getThreadsCallback);if(b.gemini_support==false){$("#btn_SIM1").text(langs.smsmms_js_btn_send_str);$("#btn_SIM2").hide()}else{$("#btn_SIM1").html('<span class="arial">SIM1</span>'+langs.smsmms_js_btn_send_str);$("#btn_SIM2").show()}if(b.slot0==1){$("#btn_SIM1").removeAttr("disabled")}else{$("#btn_SIM1").attr("disabled","disabled")}if(b.slot1==1){$("#btn_SIM2").removeAttr("disabled").show()}else{$("#btn_SIM2").attr("disabled","disabled")}if(b.vivoCloud==true){$("#backupSms").removeClass("disable")}else{$("#backupSms").addClass("disable")}if(window.isFavEncrypted()==true){$("#favcontent .encrypted").show();$("#favpasswd").val("");$("#favpasswderror").hide()}else{$("#favcontent .encrypted").hide()}if(b.bSupportFav==false){$("#fav").hide();$(".drawer .list").css({height:"440px"})}else{$("#fav").show();$(".drawer .list").css({height:"410px"});getFavSmsCall()}getSimSmsCall();a.hide()}else{$(".contextmenu").hide();$("#threads").empty();$("#mmsSmscontent").empty();$("#favSmscontent").empty();$("#simSmscontent").empty();$("#searchcontent .contentTop").empty();InitStatus.favSms=false;InitStatus.simSms=false;$(".category-selected").removeClass("category-selected");$("#apply2all").prop("checked",false);$("#passwd").val("");$("#unConected").show()}$("#allSms,#allThreads,#allSimSms,#allFavSms").attr("checked",false);$("#delSms").addClass("disable");$("#delThreads,#exportThreads").attr("disabled",true);$("#bubble").hide()}(function(){document.oncontextmenu=function(a){var b=window.getSelection().toString();if(a.srcElement.id=="messageBody"||a.srcElement.id=="smsSearch"){return true}if(b!=""){return true}return false};$(document).ready(function(){$("body").on("mousedown",".contextmenu",function(e){e.stopPropagation()}).mousedown(function(){global.hide($("#threadContextMenu,#importAndExportContextMenu,#ExportContextSubMenu,#ThreadSortMenu,#ExportContextThreadSubMenu"))});$(window).resize(function(){var f=$("#threads");var e;if($("#fav").is(":visible")){e=f.parent().height()-170}else{e=f.parent().height()-135}f.height(e)});console.log("ready");$charNum=$("#charNum");$smsNum=$("#smsNum");$("#messageBody").bind("input change",function(f){$charNum.text(this.value.length);$smsNum.text(Util.getSmsCount(this))});$("#messageBody").bind("paste",function(g){var f=g.originalEvent.clipboardData.getData("text/plain")+this.value;if(escape(f).indexOf("%u")<0){$(this).prop("maxlength",1224)}else{$(this).prop("maxlength",536)}});$("#messageBody").bind("keydown",function(i){var f=$("#messageBody").val();if(i.ctrlKey&&i.which==13){if(!$("#btn_SIM1").attr("disabled")){var h=parseInt($("#threads li[data-click]").attr("id"));var g=$("#smscontent .contentTop").find(".phoneNumber").text().split(",");SendSmsCall(f,g,0,h);return false}}else{if(i.shiftKey&&i.which==13){if(!$("#btn_SIM2").attr("disabled")){var h=parseInt($("#threads li[data-click]").attr("id"));var g=$("#smscontent .contentTop").find(".phoneNumber").text().split(",");SendSmsCall(f,g,1,h);return false}}}});$(".category").click(function(){$("#searchcontent").hide();$("#searchresultcontent").empty();if($(this).hasClass("category-selected")){return}$(".category-selected").removeClass("category-selected");$(this).addClass("category-selected");$(".content").hide();var i=$(this).attr("id");$(".content").hide();$("#"+i+"content").show();if(i==="collection"&&$("#collectionSmscontent").length===0){$("#"+i+"content").append('<iframe name="collSms" id="collectionSmscontent" src="http://zs.vivo.com.cn/collSms.php" onload="getDress(\''+i+'\');"></iframe><div id="collectionLoading" class="iframeLoading"></div>');$("#collectionLoading").show()}if($(".content:visible").first().find(".showcontent input:checked").length===0){$("#delSms").addClass("disable")}else{$("#delSms").removeClass("disable")}if(i=="sms"){var e=document.querySelector("#threads li[data-click]");if(e){$(e).attr("data-click",true);var g=$(e).attr("id");if(g==undefined){return}g=parseInt(g);var h=window.getThreadObjectEx(g);if(h==null){return}if(h.thread.stranger===true){$("#smscontent .contentTop").find(".contact").text(langs.smsmms_js_add_contact_str).addClass("addToContacts")}else{$("#smscontent .contentTop").find(".contact").text(h.thread.contact).removeClass("addToContacts")}}else{e=document.querySelectorAll("#threads li")[0];if(e){$(e).click()}}}else{if(i=="collection"){$("#threads li[data-click]").attr("data-click",false)}else{if(i=="fav"){$("#threads li[data-click]").attr("data-click",false);if(window.isFavEncrypted()==true){$("#favcontent .encrypted").show();$("#favpasswd").val("");$("#favpasswderror").hide()}else{$("#favcontent .encrypted").hide();if(InitStatus.favSms===false){var f=$("#bubble");f.find(".bubble_text").html('<div class="refresh" ></div>'+langs.smsmms_js_get_fav_str);f.show()}}}else{if(i=="sim"){$("#threads li[data-click]").attr("data-click",false);if(InitStatus.simSms===false){var f=$("#bubble");f.find(".bubble_text").html('<div class="refresh" ></div>'+langs.smsmms_js_get_sim_str);f.show()}}}}}});$("#sms").click();window.isConnected(function(g,f){if(g){$("#unConected").hide();var e=$("#bubble");e.find(".bubble_text").html('<div class="refresh" ></div>'+langs.smsmms_js_get_sms_str);e.show();if(!f){$("#fav").hide();$(".drawer .list").css({height:"440px"})}else{$("#fav").show();$(".drawer .list").css({height:"410px"})}}else{$("#unConected").show()}});$(".showcontent").on("click",".daysplit",function(){var e=$(this).next();if($(this).hasClass("smsHide")){while(!e.hasClass("daysplit")){e.show();if(e.is(":last-child")){break}e=e.next()}$(this).removeClass("smsHide")}else{while(!e.hasClass("daysplit")){if(e.is(":last-child")){if(!e.hasClass("moreSearchResult")){e.hide()}break}e.hide();e=e.next()}$(this).addClass("smsHide")}});$(".showcontent").on("change","li input",function(){var e=$("#delSms");var h=$(this).parent().parent().parent();var g=h.prev().children("input");if($(this).prop("checked")){if(e.hasClass("disable")){e.removeClass("disable")}var f=h.find("li input:not(:checked)").length;if(g.prop("checked")==false&&f==0){g.prop("checked",true)}}else{if($(this).prop("checked")==false){var f=h.find("li input:checked").length;if(e.hasClass("disable")==false&&f==0){e.addClass("disable")}g.prop("checked",false)}}});$(".showcontent").on("click","li .forward",function(){$.ajax({url:"http://vivozs/mmssms/smsSendder",type:"POST",data:{type:"forward",body:$(this.parentNode).find(".body").text()},success:function(e){console.log(e)}})});$(".showcontent").on("dblclick",".speech",function(){if(this.id.lastIndexOf("Mms")>-1){return}var e=$(this).find(".body").text();window.setClipboard(e);$("#tips").text(langs.smsmms_js_sms_copied_str);$("#tips").fadeIn(500).fadeOut(2000);if($(this).find('.status[data-status="3"]').length==1){$("#messageBody").append(e)}});$(".showcontent").on("click","li .del",function(){localStorage.remDel="1";var e=[];e.push(this.parentNode.parentNode.id);DeleteSmsCall(e)});$("#mmsSmscontent,#searchresultcontent").on("click","li .copy",function(){var e=this.parentNode.parentNode.id;e=parseInt(e);CopySms2FavCall(e)});$("#mmsSmscontent").on("click","li .saveattachment",function(){console.log(this);var e=this.parentNode.parentNode.id;e=parseInt(e);getMmsCall(e,function(f){window.saveAttachment(f)})});var b=document.querySelector("#mmsSmscontent");var a=document.querySelector("#favSmscontent");var d=document.querySelector("#simSmscontent");var c=new WebKitMutationObserver(function(e){e.forEach(function(h){var g;if($("#searchcontent").is(":visible")){g=$("#searchcontent .showcontent")}else{g=$(h.target)}var i=g.find("li .speech");var f=g.find("li input:checked");if(i.length==0){$(h.target).next().show();if($(h.target).is(":visible")){$("#delSms").addClass("disable")}}else{if(f.length==0){if($(h.target).is(":visible")){$("#delSms").addClass("disable")}}else{if(f.length==i.length){$(h.target).parent().find(".contentTop input").prop("checked",true)}}}})});c.observe(b,{childList:true,attributes:true});c.observe(a,{childList:true,attributes:true});c.observe(d,{childList:true,attributes:true});new WebKitMutationObserver(function(e){e.forEach(function(f){var h=f.target.querySelectorAll("li input:checked").length;var g=f.target.querySelectorAll("li").length;if(h===0){$("#delThreads,#exportThreads").attr("disabled","disabled");$("#allThreads").prop("checked",false)}else{if(h===g){$("#allThreads").prop("checked",true)}}if(g===0){$("#smscontent .encrypted").hide();$("#mmsSmscontent").empty();$("#smscontent .noSmscontent").show();$("#sortButton").attr("disabled","disabled")}else{$("#sortButton").removeAttr("disabled")}})}).observe(document.querySelector("#threads"),{childList:true,attributes:true});$("#simSmscontent").on("click","li .copy",function(){var e=this.parentNode.parentNode.id;e=parseInt(e);CopySimSms2Phone(e)});$("#threads").on("click","li",function(i){$("#searchcontent").hide();$("#searchresultcontent").empty();if($("#smscontent").is(":visible")==false){$(".content").hide();$("#smscontent").show();$(".category-selected").removeClass("category-selected")}if($(this).attr("data-click")==undefined||$(this).attr("data-click")=="false"){$("#threads li[data-click]").removeAttr("data-click");$(this).attr("data-click",true);$("#allSms").prop("checked",false)}var g=$(this).attr("id");if(g==undefined){return}g=parseInt(g);var h=window.getThreadObjectEx(g);if(h==null){return}if(h.thread.stranger===true){$("#smscontent .contentTop").find(".contact").text(langs.smsmms_js_add_contact_str).addClass("addToContacts")}else{$("#smscontent .contentTop").find(".contact").text(h.thread.contact).removeClass("addToContacts")}$("#smscontent .contentTop").find(".phoneNumber").text(h.thread.addr);$("#smscontent .contentTop").find(".attribution").text(h.thread.attribution);$("#smscontent .contentTop").attr("data-thread-id",g);$("#allSms").prop("checked",false);$(this).find(".count").text("("+h.thread.count+")");if(h.thread.encryted==true){$("#delSms").addClass("disable");$("#smscontent .encrypted").show();$("#passwderror").hide();$("#passwd").val("");$("#apply2all").prop("checked",false);return}else{$(this).find(".DrawerIconNotRead").remove();if(h.thread.read==false){window.readThread(g)}$("#smscontent .encrypted").hide()}if(h.sms){var f=template("MmsSms",{list:h.sms,bSupportFav:h.thread.bSupportFav});$("#smscontent .noSmscontent").hide();setTimeout(function(){var e=document.getElementById("mmsSmscontent");e.innerHTML=f;e.scrollTop=e.scrollHeight})}else{$("#smscontent .noSmscontent").show()}var j=$("#sms");$(".category-selected").removeClass("category-selected");j.addClass("category-selected")});$("#threads").on("ContactsChange","li",function(){var f=$(this).attr("id");var h=window.getThreadObject(parseInt(f));var e=h.addr;var g=h.contact;if(g.length!=0){$("#"+f+" .addr").text(g)}if($(this).attr("data-click")=="true"){if(h.stranger===true){$("#smscontent .contentTop").find(".contact").text(langs.smsmms_js_add_contact_str).addClass("addToContacts")}else{$("#smscontent .contentTop").find(".contact").text(h.contact).removeClass("addToContacts")}}});$("#sortButton").click(function(f){$("#ThreadSortMenu").css({left:f.clientX,top:f.clientY}).show()});$("#ThreadSortMenu").on("click","li",function(f){$("#sortButton").text($(this).text());window.getThreads($(this).val(),getThreadsCallback);$(".contextmenu").hide()});$("#threads").on("contextmenu","li",function(k){var m=$("#threadContextMenu");var f=$(this).find(".addr").attr("title");var i=$(this).attr("id");if(i==undefined){return}i=parseInt(i);var j=window.getThreadObjectEx(i);if(j.thread.stranger==false){$("#MenuAddContact").attr("disabled",true);m.removeAttr("data-phoneNumber")}else{$("#MenuAddContact").removeAttr("disabled");m.attr("data-phoneNumber",f)}if(j.thread.encryted==true){$("#MenuExport").attr("disabled",true)}else{$("#MenuExport").removeAttr("disabled")}global.objSmsListSize=0;j.sms.forEach(function(h){if(h.mms==0){global.objSmsListSize++}});m.attr("data-thread",this.id);var l=document.documentElement.clientHeight;var g=100;var n=k.clientY;if(l-n<g){n=l-g}m.css({left:k.clientX,top:n});global.show(m);k.stopPropagation();return false});$("#threadContextMenu,#importAndExportContextMenu,#ExportContextSubMenu,#ExportContextThreadSubMenu").on("click","li",function(f){if($(this).attr("disabled")=="disabled"||$(this).find(".right").length!=0||$(this).hasClass("hr")){return}if($(this).attr("id")=="MenuAddContact"){var p=$(this).parent().attr("data-phoneNumber");editContact(-1,p)}else{if($(this).attr("id")=="MenuDelete"){var e=[];e.push($(this).parent().attr("data-thread"));DeleteThreadsCall(e)}else{if($(this).attr("id")=="MenuImport"){$.ajax({url:"http://vivozs/mmssms/importSms",success:function(i){$(".contextmenu").hide();if(i=="ok"){art.dialog({id:"processDlg",title:langs.smsmms_js_import_str,cancelValue:langs.smsmms_js_importdlg_cancel_lang,width:"300px",initialize:function(){this.content(document.getElementById("processScript").innerHTML)},cancel:function(){window.stop();return true},beforeunload:function(){getMmsSmsCall(true)},focus:true,dblclickNotHide:true,lock:true})}}})}else{if($(this).hasClass("ExportContextBysms")||$(this).hasClass("ExportContextBycsv")){var o;if($(this).hasClass("ExportContextBysms")){o="sms"}else{if($(this).hasClass("ExportContextBycsv")){o="csv"}}var k=$(this).parent().attr("id");var l=$(this).parent().parent().attr("id");if(k==null&&(l=="MenuExportAll"||l=="MenuExportSelected")){console.log("sms");var g=sessionStorage.getItem("selected");if(typeof(g)=="undefined"||g==""||l=="MenuExportAll"){var m=$("#threads>li");var j=new Array();for(var h=0;h<m.length;h++){window.getThreadSmsIds(parseInt(m[h].id),o,function(r){for(var q=0;q<r.length;++q){if((r[q]!="")&&(typeof(r[q])!="undefined")){j=j.concat(r[q])}}})}ExportSmsCall(j.toString(),o)}else{if(o=="csv"){ExportSmsCall(sessionStorage.getItem("notMmsSelected"),o)}else{ExportSmsCall(g,o)}}}else{if(k==null&&l=="MenuExport"){console.log("oneThreadSms");var n=parseInt($("#"+ContextMenu.THREADCONTEXT).attr("data-thread"));window.getThreadSmsIds(n,o,function(s){var q=new Array();for(var r=0;r<s.length;++r){if((s[r]!="")&&(typeof(s[r])!="undefined")){q=q.concat(s[r])}}ExportSmsCall(q.toString(),o)})}else{if(k!=null&&k=="ExportContextSubMenu"){console.log("moreThreadSms");var m=$("#threads>li>input:checked");var j=new Array();for(var h=0;h<m.length;h++){window.getThreadSmsIds(parseInt(m[h].parentNode.id),o,function(r){for(var q=0;q<r.length;++q){if((r[q]!="")&&(typeof(r[q])!="undefined")){j=j.concat(r[q])}}})}console.log(j.toString());ExportSmsCall(j.toString(),o)}}}}}}}global.hide($("#threadContextMenu,#importAndExportContextMenu,#ExportContextSubMenu,#ThreadSortMenu,#ExportContextThreadSubMenu"))}).on("mouseenter","li",function(e){if($(this).attr("disabled")=="disabled"||$(this).find(".right").length==0||$(this).hasClass("hr")){return}var f=$(this).children(".contextmenu");if(this.id=="MenuExportSelected"){var g=f.children(".ExportContextBycsv");if(global.listSmsChecked.length==0){g.attr("disabled",true)}else{g.removeAttr("disabled")}}else{if(this.id=="MenuExportAll"){var g=f.children(".ExportContextBycsv");var m=$("#threads>li").find(".count");var j=0;for(var k=0;k<m.length;k++){if((j=m[k].getAttribute("smsCount"))!=0){break}}if(j==0){g.attr("disabled",true)}else{g.removeAttr("disabled")}}else{if($(this).attr("id")=="MenuExport"){var g=f.children(".ExportContextBycsv");if(global.objSmsListSize==0){g.attr("disabled",true)}else{g.removeAttr("disabled")}var n=$("#"+ContextMenu.THREADCONTEXT);var q=parseInt(n.css("top"),10)+66;var p=document.documentElement.clientHeight;console.log(p);var l=67;var o=0;console.log("bodyHeight:"+p+" pt:"+q+" h:"+l);if(p-q<l){console.log("hehe");o=p-q-l}f.css({top:o})}}}global.show(f)}).on("mouseleave","li",function(){if($(this).attr("disabled")=="disabled"||$(this).find(".right").length==0||$(this).hasClass("hr")){return}var e=$(this).children(".contextmenu");global.hide(e)});$("#InAndOutSms").on("mouseenter",function(){if(!$("#importAndExportContextMenu").is(":visible")){showOpTips($(this),langs.smsmms_js_export_tips_lang)}});$("#InAndOutSms").on("mouseleave",function(){hideOpTips()});$("#InAndOutSms").bind("click",function(m){hideOpTips();var h=$("#importAndExportContextMenu");var p;if($("#searchcontent").is(":visible")){p=$("#searchcontent .showcontent")}else{p=$(".content:visible .showcontent")}var n=p.find("li .speech");if($(n).length==0){$("#MenuExportSelected").attr("disabled",true)}else{var i=n.find("input:checked").parent().find(".status[data-status!='3']");global.listSmsChecked=p.find("li[id$=Sms] input:checked").parent().find(".status[data-status!='3']");if($(i).length==0){$("#MenuExportSelected").attr("disabled",true)}else{if($("#searchcontent").is(":visible")){var j=i.parent().find(".kind[data-kind='3']").length;var o=i.parent().find(".kind[data-kind='2']").length;if(j!=0||o!=0){$("#MenuExportSelected").attr("disabled",true)}else{$("#MenuExportSelected").removeAttr("disabled")}}else{if($("#smscontent").is(":visible")==true){$("#MenuExportSelected").removeAttr("disabled")}else{$("#MenuExportSelected").attr("disabled",true)}}}}if(window.getSmsCount()==0){$("#MenuExportAll").attr("disabled",true)}else{$("#MenuExportAll").removeAttr("disabled")}h.css({left:360,top:15});global.show(h);var f=n.find("input:checked").parent().find(".status[data-status!='3']");var l=$(f).map(function(q,e){return $(this).parent().parent().attr("id")});var k=$.makeArray(l).toString();var g=k.replace(/,?[0-9]+Mms/g,"");g=g.replace(/^,/g,"");sessionStorage.setItem("selected",k);sessionStorage.setItem("notMmsSelected",g);m.stopPropagation();return false});$("#threads").on("click","li>input",function(e){if($(this).is(":checked")){$(this).css("display","block");$("#delThreads,#exportThreads").prop("disabled",false)}else{$(this).css("display","")}if($("#threads>li>input:checked").length==$("#threads>li>input").length){$("#allThreads").prop("checked",true)}else{$("#allThreads").prop("checked",false)}if($("#threads>li>input:checked").length===0){$("#delThreads,#exportThreads").prop("disabled",true)}e.stopPropagation()});$("#allThreads").change(function(f){if($(this).is(":checked")){$("#threads>li>input").prop("checked",true);$("#threads>li>input").css("display","block")}else{$("#threads>li>input").prop("checked",false);$("#threads>li>input").css("display","")}if($("#threads>li>input:checked").length>0){$("#delThreads,#exportThreads").prop("disabled",false)}else{$("#delThreads,#exportThreads").prop("disabled",true)}});$("#delThreads").click(function(){if($(this).attr("disabled")){return}var g=$("#threads>li>input:checked");var f=[];for(var e=0;e<g.length;e++){f.push(g[e].parentNode.id)}DeleteThreadsCall(f)});$("#exportThreads").on("mouseenter",function(){if(!$(this).prop("disabled")&&!$("#"+ContextMenu.EXPORTCONTEXT).is(":visible")){showOpTips($(this),langs.smsmms_js_export_tips_lang)}});$("#exportThreads").on("mouseleave",function(){hideOpTips()});$("#exportThreads").click(function(){if($(this).attr("disabled")){return}hideOpTips();var e=$("#"+ContextMenu.EXPORTCONTEXT);var n=$("#threads>li>input:checked").parent().find(".count");var j=0;for(var k=0;k<n.length;k++){if(j+=$(n[k]).attr("smsCount")!=0){break}}console.log(n);var f=e.children(".ExportContextBycsv");if(j==0){f.attr("disabled",true)}else{f.removeAttr("disabled");e.removeClass();e.addClass("contextmenu moreThreadSms")}var o=$("#exportThreads");var g=parseInt(o.offset().left,10)+o.width()/2;var q=parseInt(o.offset().top,10)+10;var p=document.documentElement.clientHeight;var m=e.height();if(p-q<m){q-=m}e.css({left:g,top:q});global.show(e)});$("#smscontent .contentTop").on("click",".addToContacts",function(){var e=$(this).next().text();editContact(-1,e)});$("#allSms,#allFavSms,#allSimSms").on("click",function(){if($(this).is(":checked")){$(this.parentNode.parentNode).find(".showcontent>li input").prop("checked",true)}else{$(this.parentNode.parentNode).find(".showcontent>li input").prop("checked",false)}if($(this.parentNode.parentNode).find(".showcontent>li input:checked").length==0){$("#delSms").addClass("disable")}else{$("#delSms").removeClass("disable")}});$("#btn_SIM1, #btn_SIM2").bind("click",function(){var h=$(this).attr("data-slot");var g=parseInt($("#threads li[data-click]").attr("id"));var f=$("#smscontent .contentTop").find(".phoneNumber").text().split(",");var e=$("#messageBody").val();SendSmsCall(e,f,h,g)});$("#submitpasswd").bind("click",function(){var g=$("#threads li[data-click]");var h=g.attr("id");var f=$("#passwd").val();var e=$("#apply2all").prop("checked");var i=window.checkPasswd(parseInt(h),f,e);if(i===true){$(document.getElementById(h)).trigger("click")}else{$("#passwderror").show()}});$("#favsubmitpasswd").bind("click",function(){var e=$("#favpasswd").val();var f=window.checkFavPasswd(e);if(f){$("#favcontent .encrypted").hide()}else{$("#favpasswderror").show()}})})})();function topMenuBtnHandler(f){if($(f).hasClass("disable")){return}if(f.id=="newSms"){window.showSendPop(true)}else{if(f.id=="reflash"){$("#favNum").text(0);$("#simNum").text(0);getMmsSmsCall(true);$("#sms").click();$("#sortButton").text(langs.smsmms_threadsort_bytime_lang)}else{if(f.id=="delSms"){var e;localStorage.remDel="1";if($("#searchcontent").is(":visible")){e=$("#searchcontent .showcontent")}else{e=$(".content:visible .showcontent")}if(e.length>1){console.error("有"+e.length+"个showcontent处于display状态")}var b=new Array();var d=e.find("li input:checked");for(var a=0;a<d.length;a++){b.push(d[a].parentNode.parentNode.id)}DeleteSmsCall(b)}else{if(f.id=="backupSms"){var c=false;art.dialog({id:"cloudbackupDlg",title:"云备份",content:'<div >在无wifi连接的状态下，云备份需消耗<span style="color:red;" >手机流量!</span>(只支持增量备份)</div>',lock:true,width:300,okValue:"备份",dblclickNotHide:true,ok:function(){if(c==false){this.content('<div class="refresh"></div><div class="artIcontext">正在进行云备份,请稍候...</div>');$.ajax({url:"http://vivozs/mmssms/cloudbackup",success:function(g){CloseArtDialog()}});c=true}this.button({id:"ok",callback:function(){return false},disabled:true},{id:"cancel",callback:function(){return true}});return false},cancelValue:langs.smsmms_js_importdlg_cancel_lang,cancel:function(){return true}})}}}}}function getThreadsCallback(c,a){var d={list:c};var b=template("threadslist",d);$("#threads").html(b);if(c.length===0){document.getElementById("mmsSmscontent").innerHTML="";$("#smscontent .noSmscontent").show()}else{$("#threads li").first().click();$("#threads li").trigger("ContactsChange")}}function ExportSmsCall(b,a){art.dialog({id:"processDlg",title:langs.smsmms_js_export_str,cancelValue:langs.smsmms_js_importdlg_cancel_lang,width:"300px",initialize:function(){this.content(document.getElementById("processScript").innerHTML)},cancel:function(){window.stop();return true},focus:true,dblclickNotHide:true,lock:true});$.ajax({url:"http://vivozs/mmssms/exportSms",type:"POST",data:{type:a,checkeds:b},success:function(c){global.hide($(".contextmenu"));if(c=="ok"){}else{CloseArtDialog()}}})}function deleteThreads(e,f){if(e.length>0){var g=e[0];$.ajax({url:"http://vivozs/mmssms/thread/"+g,type:"DELETE",success:function(i){if(i=="error"){console.error(i);CloseArtDialog();return}$("#"+g).remove();var h=$("#nDone").text();h=parseInt(h);h++;$("#nDone").text(h.toString());$("#process").css("width",h/f*230);e.splice(0,1);deleteThreads(e,f)}})}else{CloseArtDialog();$("#searchcontent").hide();$("#searchresultcontent").empty();if(!$("#fav").hasClass("category-selected")){$("#favcontent").hide()}if(!$("#sim").hasClass("category-selected")){$("#simcontent").hide()}var d=$('#threads li[data-click="true"]');if(d.length===0){document.getElementById("threads").scrollTop=0;$("#threads li").first().click();$("#allSms").prop("checked",false)}else{d.attr("data-click",true)}window.deleteSmsUnLock();var b;if($("#searchcontent").is(":visible")){b=$("#searchcontent .showcontent")}else{b=$(".content:visible .showcontent")}var c=b.find("li .speech").length;var a=b.find("li input:checked").length;if(a>0){$("#delSms").removeClass("disable")}else{$("#delSms").addClass("disable")}if(c==0){$("#smscontent").show();$("#smscontent .noSmscontent").show()}}}function DeleteThreadsCall(a){art.dialog({id:"DeleteThreadsDlg",title:langs.smsmms_js_delete_thread_str,content:'<div style="line-height:40px;">'+langs.smsmms_js_delete_thread_content1_str+a.length+langs.smsmms_js_delete_thread_content2_str+"<div>",okValue:langs.smsmms_js_delete_sms_okbtntext_lang,cancelValue:langs.smsmms_js_importdlg_cancel_lang,width:"300px",ok:function(){this.content(document.getElementById("processScript").innerHTML);document.getElementById("nCnt").innerHTML=a.length;this.button({id:"ok",callback:function(){return false},disabled:true},{id:"cancel",callback:function(){a.splice(0,a.length);return true}});window.deleteSmsLock();deleteThreads(a,a.length);return false},cancel:function(){return true},focus:true,dblclickNotHide:true,lock:true})}function deleteSms(a,b){if(a.length>0){var c=a[0];$.ajax({url:"http://vivozs/mmssms/deleteSms/"+c,success:function(f){if(f=="error"){console.error(f);CloseArtDialog();return}var o=JSON.parse(f);if(o.thread_id!=undefined){var l=document.getElementById(o.thread_id);if(o.thread_count==0){$(l).remove()}else{$(l).find(".count").text("("+o.thread_count+")");$(l).find(".count").attr("smsCount",o.thread_smsCount);if(o.has_attachment==false&&$(l).find(".DrawerIconAttachment").length===1){$(l).find(".DrawerIconAttachment").remove()}}}var d=$("#"+o._id);if((d.prev().hasClass("daysplit")&&d.next().hasClass("daysplit"))||(d.prev().hasClass("daysplit")&&d.is(":last-child"))){d.prev().remove()}d.remove();if(o.search_id!=undefined){var d=$("#"+o.search_id);if((d.prev().hasClass("daysplit")&&d.next().hasClass("daysplit"))||(d.prev().hasClass("daysplit")&&d.is(":last-child"))){d.prev().remove()}d.remove()}var h=$("#nDone").text();h=parseInt(h);h++;$("#nDone").text(h.toString());$("#process").css("width",h/b*230);a.splice(0,1);deleteSms(a,b);if(localStorage.remDel=="1"){localStorage.remDel="0";var p=$("#searchCount");var n=parseInt(p.text())-b;p.text(n)}if(o.kind==="sim"){var g=parseInt($("#simNum").text());--g;$("#simNum").text(g)}else{if(o.kind==="fav"){var j=parseInt($("#favNum").text());--j;$("#favNum").text(j)}else{}}var m;if($("#searchcontent").is(":visible")){m=$("#searchcontent .showcontent")}else{m=$(".content:visible .showcontent")}var e=m.find("li .speech").length;var k=m.find("li input:checked").length;if(k>0){$("#delSms").removeClass("disable")}else{$("#delSms").addClass("disable")}if(e!=0&&k==e){$("#allSms").prop("checked",true)}else{$("#allSms").prop("checked",false)}var i=$("#mmsSmscontent li .speech").length;if(i==0&&$("#threads li").length!=0){$("#threads li").first().trigger("click")}}})}else{window.deleteSmsUnLock();CloseArtDialog()}}function DeleteSmsCall(a){art.dialog({id:"DeleteSmsDlg",title:langs.smsmms_js_delete_sms_str,content:'<div style="line-height:40px">'+langs.smsmms_js_delete_sms_content1_str+a.length+langs.smsmms_js_delete_sms_content2_str+"<div>",okValue:langs.smsmms_js_delete_sms_okbtntext_lang,cancelValue:langs.smsmms_js_importdlg_cancel_lang,width:"300px",ok:function(){this.content(document.getElementById("processScript").innerHTML);document.getElementById("nCnt").innerHTML=a.length;this.button({id:"ok",callback:function(){return false},disabled:true},{id:"cancel",callback:function(){a.splice(0,a.length);return true}});window.deleteSmsLock();deleteSms(a,a.length);return false},cancel:function(){return true},focus:true,dblclickNotHide:true,lock:true})}function CopySms2FavCall(a){$.ajax({url:"http://vivozs/mmssms/sms/"+a,type:"COPY",success:function(b){if(b=="ok"){$("#tips").text(langs.smsmms_js_add2fav_success_str);getFavSmsCall()}else{if(b=="exist"){$("#tips").text(langs.smsmms_js_already_exsit_str)}else{if(b=="smsnotexist"){$("#tips").text(langs.smsmms_js_sms_missing_str)}else{$("#tips").text(langs.smsmms_js_add2fav_failed_str)}}}$("#tips").fadeIn(500).fadeOut(2000)}})}function SendSmsCall(a,c,e,d){if(a==""){$("#tips").text(langs.smsmms_js_body_invalid_str);$("#tips").fadeIn(500).fadeOut(2000);return}var b={guid:window.getGuid(),body:a,address:c,slot:e,thread_id:d};$.ajax({url:"http://vivozs/mmssms/sendsms",type:"SEND",data:encodeURI(JSON.stringify(b)),success:function(f){if(f=="error"){console.error("SendSmsCall")}}});$("#messageBody").val("");$("#messageBody").trigger("change")}function JSSaveAttachInfo(a,b){if(b){$("#tips").text(langs.smsmms_js_attach_info_saveto_str+"<"+a+">")}else{$("#tips").text(langs.smsmms_js_attach_info_save_failed_str)}$("#tips").fadeIn(500).fadeOut(4000)}function JSSendSmsResult(c,b){var a=document.getElementById(c);if(a==null){return}if(b){$(a).find(".status").text("")}else{$(a).find(".status").text(langs.smsmms_js_send_failed_str).attr("data-status","5")}}function JSContactsChange(a){if(a==="-1"){$("#threads li").trigger("ContactsChange")}else{var b=a.split(",");b.forEach(function(c){$("#"+c).trigger("ContactsChange")})}}function JSNewSms(h,c){var b=window.getSmsObject(h);var d=document.getElementById(b.thread_id);if(d==null){$("#allThreads").attr("checked",false);var j=window.getThreadObject(b.thread_id);var i=new Array();i.push(j);var e={list:i};var f=template("threadslist",e);$("#threads").prepend(f);if($("#threads li[data-click]").length==0){$("#threads li").first().trigger("click")}return}if(b){if($(d).attr("data-click")=="true"&&$("#smscontent .encrypted").is(":visible")==false){var f=template("OneSms",{sms:b});$("#mmsSmscontent").append(f);$("#allSms").prop("checked",false);var a=document.getElementById("mmsSmscontent");a.scrollTop=a.scrollHeight}if($(d).find(".DrawerIconNotRead").length==0){$(d).append('<span class="DrawerIconNotRead"></span>')}var g=parseInt($(d).find(".count").text().substring(1));g++;$(d).find(".count").text("("+g+")")}}function JSAddSms(g){var d=document.getElementById(g.thread_id);if(d==null){var a=window.getThreadObject(g.thread_id);var f=new Array();f.push(a);var e={list:f};var c=template("threadslist",e);$("#threads").prepend(c);$("#allThreads").prop("checked",false);$(document.getElementById(g.thread_id)).trigger("ContactsChange");if($("#threads li[data-click]").length==0){$("#threads li").first().trigger("click")}return}$(d).find(".count").text("("+g.count+")");if(g.encrypted==false&&$(d).attr("data-click")==="true"){$.each(g.sms,function(k,j){var l=window.getSmsObject(j);if(l){var h=template("OneSms",{sms:l});$("#mmsSmscontent").append(h);$("#allSms").prop("checked",false)}});var b=document.getElementById("mmsSmscontent");b.scrollTop=b.scrollHeight}}function searchSms(b){if(b.value==""){return}var a=b.value;$(".category-selected").removeClass("category-selected");$("#searchcontent").show();$.ajax({url:"http://vivozs/mmssms/searchSms",data:a,type:"POST",success:function(e){$("#searchresultcontent").empty();var c=JSON.parse(e);$("#delSms").addClass("disable");if(c===null){$("#searchcontent .noSmscontent").show();return}$("#searchcontent .noSmscontent").hide();var d='<label><font color="red">'+a+"</font></label>，"+langs.smsmms_js_find_str+'<font id="searchCount" color="red">'+c.nCnt+"</font>"+langs.smsmms_js_results_str;$("#searchcontent .contentTop").html(d);renderSearchSms(c.resultArray,a);$("#searchresultcontent").show()}})}function loadmore(b){var a=sessionStorage.getItem("searchSms");var e=JSON.parse(a);var d=$(b).attr("data-searchText");var c=new Date(parseInt($(b).attr("data-startDay")));$(b).parent().remove();renderSearchSms(e,d,c)}function renderSearchSms(k,l,j){if(k===undefined){return}var h=$("#searchresultcontent .moreSearchResult button");var b=$("#searchresultcontent");var c='<font color="red">'+l+"</font>";var d=k.splice(0,30);for(var f=0;f<d.length;f++){var a=window.getSearchSms(d[f]);if(j==undefined||j.isSameDay(a.date)==false){if(a.kind!==SmsKind.SIM){j=a.date;$("#searchresultcontent").append('<li class="daysplit">'+j.toSplitString()+"</li>")}}var e={sms:a,replaceText:c,MessageType:MessageType,SmsKind:SmsKind,regexp:new RegExp(l,"g")};var g=template("MmsSmsSearchResult",e);$("#searchresultcontent").append(g)}if(k.length>0){$("#searchresultcontent").append('<li class="moreSearchResult"><button onclick="loadmore(this)">'+langs.smsmms_js_btn_more_str+"</button></li>");$("#searchresultcontent .moreSearchResult button").attr("data-searchText",l);$("#searchresultcontent .moreSearchResult button").attr("data-startDay",j.getTime())}sessionStorage.setItem("searchSms",JSON.stringify(k))}function JSOnprocess(d,a,c,b){if(c){if(b){if(a==0){$(".processTxt").append('<label class="d-over-tip">'+langs.smsmms_js_tips_no_sms_export_str+"</label>")}else{if(d==a){$(".processTxt").append('<label class="d-over-tip">'+langs.smsmms_js_tips_over_str+"</label>")}else{$(".processTxt").append('<label class="d-error-tip" style="color:#818181">'+(a-d)+langs.smsmms_js_tips_export_failed_str+"</label>")}}}else{if(a==0){$(".processTxt").append('<label class="d-over-tip">'+langs.smsmms_js_tips_no_sms_import_str+"</label>")}else{if(d==a){$(".processTxt").append('<label class="d-over-tip">'+langs.smsmms_js_tips_over_str+"</label>")}else{$(".processTxt").append('<label class="d-error-tip" style="color:#818181">'+(a-d)+langs.smsmms_js_tips_import_failed_str+"</label>")}}}setTimeout(function(){CloseArtDialog()},1000)}$("#nDone").text(d);$("#nCnt").text(a);if(parseInt(d)!=0){$("#process").css("width",d/a*230)}else{$("#process").css("width",0*230)}}function JSOnSimStateChange(a){if(a.slot0==1){$("#btn_SIM1").removeAttr("disabled")}else{$("#btn_SIM1").attr("disabled","disabled")}if(a.slot1==1){$("#btn_SIM2").removeAttr("disabled").show()}else{$("#btn_SIM2").attr("disabled","disabled")}}function CloseArtDialog(){var a=art.dialog.get();for(var b in a){a[b].close()}}function editContact(f,b){var d=b.split(",");var e=new Array();for(var c=0;c<d.length;++c){e[c]={dataid:-1,number:d[c]}}var a={_id:f,phone:e};$.ajax({url:"http://contact/editContact",type:"POST",data:JSON.stringify(a),success:function(g){var h=parseInt(g);if(h>0){window.updateContact(h)}}})}function showThread(b){var a=document.getElementById(b);$(a).click()}function hideMessPrompt(a){localStorage.messPrompt="1";$(a).parent().hide()}function openFileError(){var a=art.dialog.get();a.processDlg.content("<div>"+langs.smsmms_js_checkfile_error_str+"</div>");setTimeout(function(){CloseArtDialog()},1500)}function showOpTips(b,e){$("#opTips").text(e).show();var c=$(b);var a=$(b).offset().left;var f=$(b).offset().top;var d=$(b).height();$("#opTips").css({left:a,top:f+d+2}).show();$("#opTips").html(e).show()}function hideOpTips(){$("#opTips").hide()};