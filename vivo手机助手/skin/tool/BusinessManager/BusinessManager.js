if(typeof columnCur=="undefined"){var columnCur={COL_NONE:0,COL_INDEX:1,COL_NAME:2,COL_NUMBER:3,COL_SMSTEXT:4,COL_SMSRELY:5,COL_NOTES:6}}if(typeof JsCommand_type=="undefined"){var JsCommand_type={JS_COMMAND_LOADFROM_FILE:"IMPORT_EXEL",JS_COMMAND_SAVETO_FILE:"EXPORT_EXEL",JS_COMMAND_SMSMODEL:"SMSMODEL",JS_COMMAND_SENDMESSAGE:"SENDMESSAGE",JS_COMMAND_DELETE:"DELETE",JS_COMMAND_IMPORT_TOPHONE:"IMPORT_PHONE",JS_COMMAND_REFRESH:"REFRESH",JS_COMMAND_SIMCHANGE:"SIMCHANGE",JS_COMMAND_ORDERBY_INDEX:"ORDERBY_INDEX",JS_COMMAND_ORDERBY_SMSRELY:"ORDERBY_SMSRELY",JS_COMMAND_ORDERBY_NOTES:"ORDERBY_NOTES",JS_COMMAND_ADD_BUSICON:"ADD_BUSICON",JS_COMMAND_INSERT_BUSICON:"INSERT_BUSICON",JS_COMMAND_LISTITEM_UPDATE:"LISTITEM_UPDATE",JS_COMMAND_CLICK_NUMBER:"CLICK_NUMBER",JS_COMMAND_SIM_INFO:"SIM_INFO"}}var global={list_id_cur:0,list_column_cur:columnCur.COL_NONE,list_itemobj_cur:null,defaultSim:0,smsModelDefault:"",groupNameDefault:"",simCount:0,dataArray:null,hotInstance:null,contactCkeckedList:new Array(),counter:0,AllRemoveRowsNum:0};var ids="_";$(document).ready(function(){enableEditButtons(false);$("#sel_all").bind("click",function(){if($(this).prop("checked")){$("#contact_list .ht_clone_left input:checkbox").prop("checked",true);setCkeckedListByAllRows()}else{$("#contact_list .ht_clone_left input:checkbox").prop("checked",false);cleanCheckedListByAllRows()}event.stopPropagation()});$("#selectAll").bind("click",function(){if(!$("#sel_all").prop("checked")){$("#sel_all").prop("checked",true);$("#contact_list .ht_clone_left input:checkbox").prop("checked",true);setCkeckedListByAllRows()}else{$("#sel_all").prop("checked",false);$("#contact_list .ht_clone_left input:checkbox").prop("checked",false);cleanCheckedListByAllRows()}});var a="";var c="";$("#contact_list").handsontable({data:global.dataArray,minRows:1,startRows:1,width:800,height:510,colWidths:[80,100,210,240,66],stretchH:"last",rowHeaders:function(f){var h="";if(global.contactCkeckedList.length!=0){var g=getPhysicalIndex(f);var e=binsearch(global.contactCkeckedList,g);if(e!=-1&&global.contactCkeckedList[e]==g){h="checked"}}var d="";d="<div class='list_index listItem'>";d+="<input class='sel_con' type=\"checkbox\" "+h+" />";f++;d+="<div class='list_index_text'>"+f+"</div>";d+="</div>";return d},colHeaders:["姓名","号码","发送短信内容","最新回复短信","备注"],columns:[{data:"0",renderer:b},{data:"1",renderer:b},{data:"2",renderer:b},{data:"3",readOnly:true},{data:"4"}],contextMenu:getContextMenu(),beforeChange:function(g,f){if(f!=="loadData"){for(var d=0;d<g.length;d++){if(isCellEmpty(g[d][2])&&isCellEmpty(g[d][3])){g.splice(d,1)}else{if(g[d][1]=="1"){var e=/^((\+86)|(86))?\d{1,11}$/g;if(!isCellEmpty(g[d][3])&&!e.test(g[d][3])){g.splice(d,1)}}}}}},afterChange:function(e,d){if(d!=="loadData"){changeData(e)}else{global.contactCkeckedList.splice(0,global.contactCkeckedList.length);settleBtnStatesByData()}},afterCreateRow:function(d,e){afterCreateRows(d,e)},afterRemoveRow:function(d,e){},afterRowMove:function(e,d){}});global.hotInstance=$("#contact_list").handsontable("getInstance");global.hotInstance.selectCell(0,0);function b(e,d,i,f,j,h,g){Handsontable.renderers.TextRenderer.apply(this,arguments);if(isRowInIndexUnderChecked(i)){if(typeof(h)=="undefined"||h==null||h==""){Handsontable.Dom.addClass(d,"htInvalid")}}else{Handsontable.Dom.removeClass(d,"htInvalid")}}$("#contact_list").on("click",".sel_con",function(e){var d=$(this).next(".list_index_text").html()-1;setCkeckedListByRow(d);e.stopPropagation()}).on("change",".sel_con",function(e){var d=0;e.stopPropagation()});$("#textModeInput").keyup(function(){hideConmenu_Input();event.stopPropagation()});$("#GroupNameInputDiv").keyup(function(){hideConmenu_Input();event.stopPropagation()});$("#sendMessages").on("click",function(){sendMessages(this)}).on("mouseout",function(){hideOpTips()}).on("mouseover",function(){if($(this).hasClass("disable")){$(this).css({cursor:"default"})}else{$(this).css({cursor:"pointer"})}showOpTips(this,"给选择的人群发短信，双卡机可点击右侧切换SIM卡发送信息。")});$("#deletePeoples").on("click",function(){deleteDatas()}).on("mouseout",function(){hideOpTips()}).on("mouseover",function(){if($(this).hasClass("disable")){$(this).css({cursor:"default"})}else{$(this).css({cursor:"pointer"})}showOpTips(this,"在程序中删除，不修改Excel文件")});$("#importToPhone").on("click",function(){importToPhone()}).on("mouseout",function(){hideOpTips()}).on("mouseover",function(){if($(this).hasClass("disable")){$(this).css({cursor:"default"})}else{$(this).css({cursor:"pointer"})}showOpTips(this,"使用vivo手机助手可以按群组导入联系人")})});window.onload=function(){getSimInfo()};function getContextMenu(){return{items:{row_above:{name:"在上方增加新行"},row_below:{name:"在下方增加新行"}}}}function getPhysicalIndex(b){var a=0;if(global.hotInstance.sortingEnabled&&typeof global.hotInstance.sortColumn!="undefined"){a=global.hotInstance.sortIndex[b][0]}else{if(global.hotInstance.getSettings().manualRowMove&&typeof global.hotInstance.manualRowPositions[b]!=="undefined"){a=global.hotInstance.manualRowPositions[b]}else{a=b}}return a}function reSetLogicalIndexArray(){if(global.hotInstance.sortingEnabled&&typeof global.hotInstance.sortColumn!="undefined"){global.hotInstance.sortColumn=null;for(var a=0;a<global.hotInstance.sortIndex.length;a++){global.hotInstance.sortIndex[a]=a}}if(global.hotInstance.getSettings().manualRowMove){for(var a=0;a<global.hotInstance.manualRowPositions.length;a++){global.hotInstance.manualRowPositions[a]=a}}}function changeCheckContactListAfterCreate(b,c){var a=binsearch(global.contactCkeckedList,b);if(a!=-1){for(;a<global.contactCkeckedList.length;a++){global.contactCkeckedList[a]+=c}}settleBtnStatesByData()}function changeCheckContactListAfterRemove(b,d){var a=-1;for(var c=0;c<d;c++){a=binsearch(global.contactCkeckedList,b+c);if(a!=-1&&global.contactCkeckedList[a]==b+c){global.contactCkeckedList.splice(a,1)}}a=b+d;if(a<global.contactCkeckedList.length){for(;a<global.contactCkeckedList.length;a++){global.contactCkeckedList[a]-=d}}settleBtnStatesByData()}function binsearch(e,d){var b=0;var c=e.length-1;var a=-1;while(c>=b){a=parseInt((c+b)/2);if(e[a]==d){return a}if(e[a]>d){c=a-1}else{if(e[a]<d){b=a+1}}}return b<=e.length-1?b:-1}function changeData(c){var b="";var f=true;var e=false;for(var a=0;a<c.length;a++){if(!(c[a][3]==undefined||c[a][2]==c[a][3])){var d=getPhysicalIndex(c[a][0]);if(!f){b+=","}b+='{"id":"'+d+'","elem":"'+c[a][1]+'","text":"'+c[a][3].replace("\\","\\\\")+'"}';f=false;if(!e){checkIndex=binsearch(global.contactCkeckedList,d);if(checkIndex!=-1&&global.contactCkeckedList[checkIndex]==d){e=true}}}}if(b==""){return}b='{"datas":['+b+"]}";$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_LISTITEM_UPDATE,data:b,success:function(g){if(g!=""&&g!=null){if(g!="ok"){}else{}}},error:function(){console.log("操作执行失败，请重试！")}});if(e){settleBtnStatesByData()}}function getSimInfo(){$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_SIM_INFO,success:function(a){if(typeof(a)=="string"){a=JSON.parse(a)}if(typeof(a)!="undefined"&&a!=null){global.simCount=a.sim_count}else{global.simCount=0}console.log(global.simCount);if(global.simCount>1){$("#setDefaultSim").show()}else{$("#setDefaultSim").hide()}},error:function(){},complete:function(){}})}function onConnected(a){if(typeof(a)=="string"){a=JSON.parse(a)}if(typeof(a)!="undefined"&&a!=null){global.simCount=a.sim_count;var b=a.connected;if(b==0){global.simCount=0;$("#sendMessages").addClass("disable");$("#importToPhone").addClass("disable")}else{settleBtnStatesByData()}}else{global.simCount=0}if(global.simCount>1){$("#setDefaultSim").show()}else{$("#setDefaultSim").hide()}}document.oncontextmenu=new Function("return false;");document.getElementById("contact_list").oncontextmenu=new Function("return true;");function showOpTips(b,e){$("#opTips").text(e).show();var c=$(b);var a=$(b).offset().left;var f=$(b).offset().top;var d=$(b).height();$("#opTips").css({left:a,top:f+d+2}).show();$("#opTips").html(e).show()}function hideOpTips(){$("#opTips").hide()}function showLoadingPic(){$("#loading").show()}function hideLoad(){$("#loading").hide();$("#textModelInputDiv").hide()}function barMouseDown(){window.ncHit(event.clientX,event.clientY)}function closeMouseDown(){event.stopPropagation()}function closeClick(){window.closeDialog()}function MinClick(){window.minDialog()}function MinMouseDown(){event.stopPropagation()}function enableEditButtons(a){if(a){$("#sendMessages").removeClass("disable");$("#importToPhone").removeClass("disable");$("#deletePeoples").removeClass("disable")}else{$("#sendMessages").addClass("disable");$("#importToPhone").addClass("disable");$("#deletePeoples").addClass("disable")}}function settleBtnStatesByData(){var a=global.contactCkeckedList.length;var d=0;var e=true;var c=0;var g=true;var f=0;if(global.hotInstance!=null){d=global.hotInstance.countRows();for(var b=0;b<global.contactCkeckedList.length;++b){var j=global.hotInstance.getSourceDataAtRow(global.contactCkeckedList[b]);if(typeof j=="undefined"){e=false;g=false}else{if(j[1]==""||j[1]==null){e=false;g=false}if(j[0]==""||j[0]==null){g=false}if(j[2]==""||j[2]==null){e=false}if(j[0]==""||j[0]==null||j[1]==""||j[1]==null){f++}if(j[1]==""||j[1]==null||j[2]==""||j[2]==null){c++}}}global.hotInstance.render()}$("#sel_all").prop("checked",((a==d)&&(d!=0))?true:false);if(a>0){$("#deletePeoples").removeClass("disable");if(c<a&&global.simCount!=0){$("#sendMessages").removeClass("disable")}else{$("#sendMessages").addClass("disable")}if(f<a){$("#importToPhone").removeClass("disable")}else{$("#importToPhone").addClass("disable")}if(!e||global.simCount==0||!g){var h="提示：导入群组时“姓名”和“号码”不能为空，发送短信时“号码”和“发送内容”不能为空且手机须插有SIM卡！";$("#footerText").html(h);$("#footerText").show()}else{$("#footerText").hide()}}else{enableEditButtons(false);$("#footerText").hide()}}function setCkeckedListByRow(a){var b=getPhysicalIndex(a);checkIndex=binsearch(global.contactCkeckedList,b);if(checkIndex!=-1&&global.contactCkeckedList[checkIndex]==b){global.contactCkeckedList.splice(checkIndex,1)}else{global.contactCkeckedList.push(b);sortContactCkeckedList()}settleBtnStatesByData()}function setCkeckedListByAllRows(){global.contactCkeckedList.splice(0,global.contactCkeckedList.length);var b=global.hotInstance.countRows();for(var a=0;a<b;++a){global.contactCkeckedList.push(a)}sortContactCkeckedList();settleBtnStatesByData()}function cleanCheckedListByAllRows(){global.contactCkeckedList.splice(0,global.contactCkeckedList.length);settleBtnStatesByData()}function isRowInIndexUnderChecked(a){var b;checkIndex=binsearch(global.contactCkeckedList,a);if(checkIndex!=-1&&global.contactCkeckedList[checkIndex]==a){b=true}else{b=false}return b}function sortContactCkeckedList(){if(global.contactCkeckedList.length>1){global.contactCkeckedList.sort(function(d,c){return d-c})}}function importFromExel(){showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_LOADFROM_FILE,success:function(a){if(a!=""&&a!=null&&a!="ok"){reSetLogicalIndexArray();global.dataArray=JSON.parse(a);global.hotInstance.loadData(global.dataArray.data)}hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function exportToExel(){showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_SAVETO_FILE,success:function(a){hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function smsModel(){$("#textModelInputDiv").show();$("#textModeInput").focus().val(global.smsModelDefault)}function smsModelOk(){var a=$("#textModeInput").val();global.smsModelDefault=a;hideLoad();showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_SMSMODEL,data:a,success:function(b){if(b!=""&&b!=null&&b!="ok"){global.dataArray=JSON.parse(b);global.hotInstance.loadData(global.dataArray.data)}hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function smsModelCancel(){hideLoad()}function sendMessages(a){if($("#sendMessages").hasClass("disable")){return}var b=getSeledConIdsWithMod("sendMessage");sendMessagesWithIds(b)}function sendMessagesWithIds(a){if(a=="_"){return}hideLoad();showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_SENDMESSAGE,data:a,success:function(b){hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function getSeledConIdsWithMod(c){var e="";var d="";var b=[];for(var a=0;a<global.contactCkeckedList.length;a++){e=fillCsIds(e,global.contactCkeckedList[a],c);b=fillJsonWithErrorRowsById(b,global.contactCkeckedList[a],c)}e=e+"_";if(b!=null&&b.length!=0){warningRowsWithEmptyCell(b,c,e);return"_"}return e}function fillCsIds(c,b,a){if(isRightRow(b,a)){return c+"_"+b}return c}function isRightRow(e,d){var c=global.hotInstance.getSourceDataAtRow(e);var a=(d=="sendMessage"&&(isCellEmpty(c[1])||isCellEmpty(c[2])));var b=(d=="import"&&(isCellEmpty(c[0])||isCellEmpty(c[1])));if(a||b){return false}else{return true}}function fillJsonWithErrorRowsById(c,d,b){var a=chooseErrorRowWithId(d,b);if(a!=null){c.push(a)}return c}function chooseErrorRowWithId(e,d){var c=cloneRowsData(e);var a=(d=="sendMessage"&&(isCellEmpty(c[1])||isCellEmpty(c[2])));var b=(d=="import"&&(isCellEmpty(c[0])||isCellEmpty(c[1])));if(a||b){return c}else{return null}}function cloneRowsData(d){var c=global.hotInstance.getSourceDataAtRow(d);var a=new Array();var b=0;while(c[b]!==undefined){a.push(c[b]);b++}a.push(d);return a}function warningRowsWithEmptyCell(e,d,g){var c=e.length;var f="";var a="如：</br>";if(d=="sendMessage"){for(var b=0;b<e.length&&b<3;b++){a=a+"第 "+(e[b][5]+1)+" 行 ";if(isCellEmpty(e[b][1])){a+="号码为空 "}if(isCellEmpty(e[b][2])){a+="发送内容为空 "}a+="</br>"}f="号码为空或者发送内容为空"}else{if(d=="import"){for(var b=0;b<e.length&&b<3;b++){a=a+"第 "+(e[b][5]+1)+" 行 ";if(isCellEmpty(e[b][0])){a+="名字为空 "}if(isCellEmpty(e[b][1])){a+="号码为空 "}a+="</br>"}f="姓名为空或者号码为空"}}if(e.length>3){a+="……</br>"}art.dialog({title:"提醒",content:'<div class="textInput">当前页面有'+c+"行存在"+f+"的问题</br>"+a+"是否继续执行操作？</div>",lock:true,dblclickNotHide:true,width:"300px",okValue:"确定",ok:function(){executeAfterOK(d,g);return true},cancelValue:"取消",cancel:function(){return true}})}function executeAfterOK(a,b){if(a=="sendMessage"){sendMessagesWithIds(b)}else{if(a=="import"){importToPhoneWithIds(b)}}}function isCellEmpty(a){return a==""||a==null||a==undefined}function insertPeoPles(a,c){var b='{"index":'+a+',"amount":'+c+"}";$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_INSERT_BUSICON,data:b,success:function(d){if(d!=""&&d!=null){if(d!="ok"){}else{}}},error:function(){console.log("操作执行失败，请重试！")}})}function afterCreateRows(c,d){var a=d;var b=d;while(b>a){insertPeoPles(c,a);changeCheckContactListAfterCreate(c,a);b-=a;c+=a}if(b!=0){insertPeoPles(c,b);changeCheckContactListAfterCreate(c,b)}}function deleteDatas(){deletePeoples()}function deleteRows(){if(global.contactCkeckedList.length==0){return}global.AllRemoveRowsNum=global.contactCkeckedList.length;while(global.contactCkeckedList.length>0){var a=global.contactCkeckedList[global.contactCkeckedList.length-1];deleteOneRow(a)}global.hotInstance.adjustRowsAndRefreshBorders();settleBtnStatesByData()}function deleteOneRow(a){global.hotInstance.removeRow(a);global.contactCkeckedList.splice(global.contactCkeckedList.length-1,1)}function deletePeoples(){var a=getSeledConIdsWithMod("");if(a=="_"){return}hideLoad();showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_DELETE,data:a,success:function(b){if(b!=""&&b!=null){if(b!="ok"){}else{}afterRemoveBusiContacts()}hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function afterRemoveBusiContacts(){deleteRows()}function setDefaultSim(){var b="";var a="";console.log("default sim:"+global.defaultSim);if(global.defaultSim==0){global.defaultSim=1;b='<a href="javascript:setDefaultSim()">切至sim卡1发送短信息</a>';$("#setDefaultSim").html(b);a="1"}else{global.defaultSim=0;b='<a href="javascript:setDefaultSim()">切至sim卡2发送短信息</a>';$("#setDefaultSim").html(b);a="0"}$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_SIMCHANGE,data:a,success:function(c){if(c!=""&&c!=null){if(c!="ok"){}else{}}hideLoad()},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function refresh(){showLoadingPic();$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_REFRESH,success:function(a){if(a!=""&&a!="ok"&&a!=null){reSetLogicalIndexArray();global.dataArray=JSON.parse(a);global.hotInstance.loadData(global.dataArray.data)}hideLoad();global.hotInstance.selectCell(0,0)},error:function(){console.log("操作执行失败，请重试！");hideLoad();global.hotInstance.selectCell(0,0)}})}function importToPhone(){if($("#importToPhone").hasClass("disable")){return}var a=getSeledConIdsWithMod("import");importToPhoneWithIds(a)}function importToPhoneWithIds(a){if(a=="_"){return}art.dialog({title:"导入到群组",content:'<input type="text" id="GroupNameInput" class="textInput" placeholder="输入群组名">',lock:true,dblclickNotHide:true,width:"300px",okValue:"确定",ok:function(){if($("#GroupNameInput").val()===""){$("#GroupNameInput").attr("placeholder","群组名不能为空");return false}var b=$("#GroupNameInput").val();GroupNameOk(this,b,a);this.content('<img src="images/loading.gif" />');this.button({id:"ok",callback:function(){return false},disabled:true});return false},cancelValue:"取消",cancel:function(){return true}})}function GroupNameOk(d,c,b){var a='{"group":"'+c+'","ids":"'+b+'"}';$.ajax({url:"http://vivozs/businessmanager",type:JsCommand_type.JS_COMMAND_IMPORT_TOPHONE,data:a,success:function(e){d.content('<label class="processTxt">联系人导入群组完成</label></br></br><label class="tipProcessTxt">导入群组可在【联系人模块】中删除</label>');d.button({id:"ok",callback:function(){return true},disabled:false,focus:true})},error:function(){console.log("操作执行失败，请重试！");hideLoad()}})}function GroupNameCancel(){hideLoad()}function clickConNumber(a){console.log(a)}function closeDlg(){$(".coverScreen").hide()};